<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="雷諾曼卡占卜">
    <title>雷諾曼卡占卜 APP</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-gradient: linear-gradient(145deg, #2c3e50, #34495e);
            --gold: #ffd700;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        /* 頂部導航 */
        .top-nav {
            background: rgba(255,255,255,0.1) !important;
            backdrop-filter: blur(15px);
            border: none;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            color: white !important;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .nav-subtitle {
            color: rgba(255,255,255,0.8);
            font-size: 0.8rem;
            margin-top: -5px;
        }

        /* 模式選擇 */
        .mode-selector {
            background: rgba(255,255,255,0.15);
            border-radius: 25px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .mode-btn {
            background: transparent !important;
            border: none !important;
            color: rgba(255,255,255,0.8) !important;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 8px 6px !important;
            border-radius: 20px !important;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.9) !important;
            color: #2c3e50 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* 九宮格說明 */
        .nine-grid-guide {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            color: white;
            backdrop-filter: blur(5px);
        }

        .grid-positions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }

        .grid-pos {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.65rem;
            line-height: 1.2;
        }

        /* 卡片區域 */
        .card-deck {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .tarot-card {
            aspect-ratio: 2/3;
            background: var(--card-gradient);
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.4s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: none;
        }

        .tarot-card:active {
            transform: scale(0.95);
        }

        .tarot-card.flipped {
            transform: rotateY(180deg);
        }

        .tarot-card.selected {
            box-shadow: 0 0 0 3px var(--gold), 0 4px 12px rgba(0,0,0,0.3);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 6px;
        }

        .card-back {
            background: var(--card-gradient);
            color: white;
            font-size: 1.5rem;
        }

        .card-front {
            background: linear-gradient(145deg, #ecf0f1, #bdc3c7);
            transform: rotateY(180deg);
            text-align: center;
            color: #2c3e50;
        }

        .card-number {
            font-size: 0.55rem;
            font-weight: bold;
            color: #7f8c8d;
            margin-bottom: 2px;
        }

        .card-symbol {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .card-name {
            font-size: 0.6rem;
            font-weight: bold;
            margin-bottom: 2px;
            line-height: 1;
        }

        .card-meaning {
            font-size: 0.45rem;
            text-align: center;
            line-height: 1.1;
            color: #5a6c7d;
        }

        /* 底部控制欄 */
        .bottom-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 15px;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .control-btn {
            background: var(--primary-gradient) !important;
            border: none !important;
            border-radius: 15px !important;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .control-btn:active {
            transform: translateY(2px);
        }

        .control-btn.btn-secondary {
            background: linear-gradient(145deg, #95a5a6, #7f8c8d) !important;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        /* 結果模態框 */
        .reading-modal .modal-content {
            border-radius: 20px;
            border: none;
            max-height: 90vh;
            overflow-y: auto;
        }

        .reading-modal .modal-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: 20px 20px 0 0;
            border: none;
        }

        .reading-modal .btn-close {
            filter: invert(1);
        }

        /* 選中的卡片展示 */
        .selected-cards.single {
            display: grid;
            grid-template-columns: 1fr;
            max-width: 200px;
            margin: 0 auto;
        }

        .selected-cards.three {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .selected-cards.five {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .selected-cards.five .selected-card:first-child {
            grid-column: 1 / -1;
        }

        .selected-cards.nine {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .selected-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .position-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .selected-card .card-symbol {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .selected-card h6 {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .selected-card .card-meaning {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* 解讀區域 */
        .interpretation-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .position-reading {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid;
            border-left-color: #667eea;
        }

        .position-reading h6 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .position-reading p {
            margin-bottom: 0;
            line-height: 1.5;
            color: #5a6c7d;
        }

        /* 動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* 響應式調整 */
        @media (max-width: 576px) {
            .card-deck {
                grid-template-columns: repeat(6, 1fr);
                gap: 4px;
            }
            
            .mode-btn {
                font-size: 0.7rem !important;
                padding: 6px 4px !important;
            }
            
            .selected-cards.nine {
                gap: 6px;
            }
            
            .selected-card {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- 頂部導航 -->
    <nav class="navbar top-nav sticky-top">
        <div class="container-fluid">
            <div class="navbar-brand mx-auto text-center">
                <div><i class="bi bi-stars"></i> 雷諾曼卡占卜</div>
                <div class="nav-subtitle">探索命運的神秘指引</div>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="container-fluid px-3 py-3">
        <!-- 模式選擇 -->
        <div class="mode-selector mb-3 p-1">
            <div class="btn-group w-100" role="group">
                <button type="button" class="btn mode-btn active" data-mode="single">單卡</button>
                <button type="button" class="btn mode-btn" data-mode="three">三卡</button>
                <button type="button" class="btn mode-btn" data-mode="five">五卡</button>
                <button type="button" class="btn mode-btn" data-mode="nine">九宮格</button>
            </div>
        </div>

        <!-- 九宮格說明 -->
        <div class="nine-grid-guide p-3 mb-3 d-none">
            <h6 class="text-center mb-2"><i class="bi bi-grid-3x3"></i> 九宮格位置說明</h6>
            <div class="grid-positions">
                <div class="grid-pos">1.過去根源</div>
                <div class="grid-pos">2.過去影響</div>
                <div class="grid-pos">3.過去結果</div>
                <div class="grid-pos">4.現在挑戰</div>
                <div class="grid-pos">5.核心問題</div>
                <div class="grid-pos">6.現在機會</div>
                <div class="grid-pos">7.未來趨勢</div>
                <div class="grid-pos">8.外在影響</div>
                <div class="grid-pos">9.最終結果</div>
            </div>
        </div>

        <!-- 卡片區域 -->
        <div class="card-deck mb-4" id="cardDeck">
            <!-- 卡片將由 JavaScript 生成 -->
        </div>

        <!-- 進度指示 -->
        <div class="text-center mb-3">
            <small class="text-white-50">
                <span id="selectedCount">0</span> / <span id="totalNeeded">1</span> 張卡片已選擇
            </small>
            <div class="progress mt-2" style="height: 4px;">
                <div class="progress-bar bg-warning" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- 底部控制欄 -->
    <div class="bottom-controls">
        <div class="row g-2">
            <div class="col-4">
                <button class="btn control-btn btn-primary w-100" id="drawBtn">
                    <i class="bi bi-magic"></i><br>
                    <small>抽卡</small>
                </button>
            </div>
            <div class="col-4">
                <button class="btn control-btn btn-secondary w-100" id="resetBtn">
                    <i class="bi bi-arrow-clockwise"></i><br>
                    <small>重置</small>
                </button>
            </div>
            <div class="col-4">
                <button class="btn control-btn btn-secondary w-100" id="shuffleBtn">
                    <i class="bi bi-shuffle"></i><br>
                    <small>洗牌</small>
                </button>
            </div>
        </div>
    </div>

    <!-- 結果模態框 -->
    <div class="modal fade reading-modal" id="readingModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-sm-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-stars"></i> 占卜結果
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 選中的卡片 -->
                    <div class="selected-cards mb-4" id="selectedCardsDisplay">
                        <!-- 動態生成 -->
                    </div>
                    
                    <!-- 解讀內容 -->
                    <div class="interpretation-section" id="interpretationContent">
                        <!-- 動態生成 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">
                        <i class="bi bi-check-circle"></i> 了解
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <script>
        // 雷諾曼卡數據
        const lenormandCards = [
            { id: 1, name: "騎士", symbol: "🏇", meaning: "消息、快速變化、年輕男性", interpretation: "代表即將到來的消息或快速的變化。可能是好消息的到來，或是需要迅速行動的時機。" },
            { id: 2, name: "三葉草", symbol: "🍀", meaning: "幸運、機會、希望", interpretation: "象徵幸運和機會的到來。小小的幸福和正面的變化即將發生。" },
            { id: 3, name: "船", symbol: "⛵", meaning: "旅行、遠方、探索", interpretation: "代表旅行、遠方的事物，或是探索新領域的渴望。可能暗示搬遷或遠行。" },
            { id: 4, name: "房屋", symbol: "🏠", meaning: "家庭、安全、穩定", interpretation: "象徵家庭、安全感和穩定。與家庭相關的事務或尋求安全感的需求。" },
            { id: 5, name: "樹", symbol: "🌳", meaning: "健康、成長、根基", interpretation: "代表健康、成長和深厚的根基。可能與健康問題或個人成長有關。" },
            { id: 6, name: "雲", symbol: "☁️", meaning: "困惑、不確定、障礙", interpretation: "象徵困惑、不確定性或暫時的障礙。事情可能不如表面看起來清楚。" },
            { id: 7, name: "蛇", symbol: "🐍", meaning: "欺騙、複雜、女性", interpretation: "代表複雜的情況、欺騙或狡猾的女性。需要小心處理人際關係。" },
            { id: 8, name: "棺材", symbol: "⚰️", meaning: "結束、轉變、疾病", interpretation: "象徵結束、重大轉變或健康問題。舊的階段結束，新的開始即將到來。" },
            { id: 9, name: "花束", symbol: "💐", meaning: "禮物、邀請、社交", interpretation: "代表禮物、邀請或社交活動。人際關係中的正面發展。" },
            { id: 10, name: "鐮刀", symbol: "🗡️", meaning: "危險、突然、收穫", interpretation: "象徵突然的變化、危險或收穫的時刻。需要謹慎行事。" },
            { id: 11, name: "鞭子", symbol: "🔗", meaning: "爭論、重複、運動", interpretation: "代表爭論、重複的模式或體育活動。可能有衝突需要解決。" },
            { id: 12, name: "鳥", symbol: "🐦", meaning: "對話、焦慮、社交", interpretation: "象徵對話、交流或焦慮。與溝通和社交互動相關。" },
            { id: 13, name: "孩子", symbol: "👶", meaning: "新開始、純真、小事", interpretation: "代表新的開始、純真或小規模的事物。新項目或創意的萌芽。" },
            { id: 14, name: "狐狸", symbol: "🦊", meaning: "狡猾、工作、欺騙", interpretation: "象徵狡猾、工作環境或可能的欺騙。需要運用智慧和謹慎。" },
            { id: 15, name: "熊", symbol: "🐻", meaning: "力量、保護、母親", interpretation: "代表力量、保護和母性能量。強大的支持者或權威人物。" },
            { id: 16, name: "星星", symbol: "⭐", meaning: "希望、願望、指引", interpretation: "象徵希望、願望的實現和精神指引。夢想有實現的可能。" },
            { id: 17, name: "鸛", symbol: "🦢", meaning: "變化、搬遷、季節", interpretation: "代表重大變化、搬遷或季節性的轉變。生活中的重要轉折點。" },
            { id: 18, name: "狗", symbol: "🐕", meaning: "忠誠、友誼、可靠", interpretation: "象徵忠誠、真正的友誼和可靠的支持。值得信賴的朋友或夥伴。" },
            { id: 19, name: "塔", symbol: "🗼", meaning: "孤獨、權威、機構", interpretation: "代表孤獨、權威機構或官僚體系。可能需要獨立思考。" },
            { id: 20, name: "花園", symbol: "🌺", meaning: "社交、公眾、聚會", interpretation: "象徵社交活動、公眾場合或聚會。人際網絡的重要性。" },
            { id: 21, name: "山", symbol: "⛰️", meaning: "障礙、挑戰、延遲", interpretation: "代表障礙、挑戰或延遲。需要耐心和毅力來克服困難。" },
            { id: 22, name: "道路", symbol: "🛤️", meaning: "選擇、決定、方向", interpretation: "象徵選擇、重要決定或人生方向。面臨重要的十字路口。" },
            { id: 23, name: "老鼠", symbol: "🐭", meaning: "損失、減少、壓力", interpretation: "代表損失、逐漸減少或壓力。需要注意資源的保護。" },
            { id: 24, name: "心", symbol: "❤️", meaning: "愛情、情感、快樂", interpretation: "象徵愛情、深刻的情感和內心的快樂。感情生活的重要發展。" },
            { id: 25, name: "戒指", symbol: "💍", meaning: "承諾、合約、循環", interpretation: "代表承諾、合約或循環的模式。重要的約定或協議。" },
            { id: 26, name: "書", symbol: "📚", meaning: "知識、秘密、學習", interpretation: "象徵知識、隱藏的秘密或學習的機會。重要信息的揭示。" },
            { id: 27, name: "信", symbol: "✉️", meaning: "消息、文件、溝通", interpretation: "代表重要消息、文件或正式溝通。可能收到重要的信息。" },
            { id: 28, name: "男人", symbol: "👨", meaning: "男性、陽性能量、行動", interpretation: "象徵重要的男性人物或陽性能量。行動和決斷力的體現。" },
            { id: 29, name: "女人", symbol: "👩", meaning: "女性、陰性能量、直覺", interpretation: "代表重要的女性人物或陰性能量。直覺和感性的重要性。" },
            { id: 30, name: "百合", symbol: "🌸", meaning: "和平、純潔、成熟", interpretation: "象徵和平、純潔和成熟的智慧。內心的平靜和和諧。" },
            { id: 31, name: "太陽", symbol: "☀️", meaning: "成功、能量、積極", interpretation: "代表成功、充沛的能量和積極的結果。光明和溫暖的未來。" },
            { id: 32, name: "月亮", symbol: "🌙", meaning: "直覺、週期、榮譽", interpretation: "象徵直覺、自然週期和榮譽。內在智慧的指引。" },
            { id: 33, name: "鑰匙", symbol: "🗝️", meaning: "解答、發現、重要", interpretation: "代表重要的解答、新發現或關鍵的突破。問題的解決方案。" },
            { id: 34, name: "魚", symbol: "🐟", meaning: "財富、獨立、商業", interpretation: "象徵財富、經濟獨立或商業機會。物質方面的豐盛。" },
            { id: 35, name: "錨", symbol: "⚓", meaning: "穩定、安全、工作", interpretation: "代表穩定、安全感和穩固的工作。堅實的基礎和可靠性。" },
            { id: 36, name: "十字架", symbol: "✝️", meaning: "負擔、犧牲、精神", interpretation: "象徵負擔、必要的犧牲或精神成長。通過困難獲得智慧。" }
        ];

        // 九宮格位置說明
        const nineGridPositions = [
            { position: 1, title: "過去根源", description: "問題或情況的起源和根本原因" },
            { position: 2, title: "過去影響", description: "過去經歷對現狀的影響" },
            { position: 3, title: "過去結果", description: "過去行動所帶來的結果" },
            { position: 4, title: "現在挑戰", description: "目前面臨的主要挑戰或阻礙" },
            { position: 5, title: "核心問題", description: "情況的核心和最重要的因素" },
            { position: 6, title: "現在機會", description: "當前可以把握的機會和資源" },
            { position: 7, title: "未來趨勢", description: "事情發展的可能趨勢" },
            { position: 8, title: "外在影響", description: "外部環境和他人的影響" },
            { position: 9, title: "最終結果", description: "如果按現在的方向發展的最終結果" }
        ];

        // 全局變量
        let selectedCards = [];
        let currentMode = 'single';
        let isDrawing = false;

        // 文檔就緒
        $(document).ready(function() {
            initializeApp();
        });

        // 初始化應用
        function initializeApp() {
            renderCards();
            setupEventListeners();
            updateUI();
            shuffleCards();
        }

        // 設置事件監聽器
        function setupEventListeners() {
            // 模式切換
            $('.mode-btn').on('click', function() {
                $('.mode-btn').removeClass('active');
                $(this).addClass('active');
                currentMode = $(this).data('mode');
                
                // 顯示/隱藏九宮格說明
                if (currentMode === 'nine') {
                    $('.nine-grid-guide').removeClass('d-none');
                } else {
                    $('.nine-grid-guide').addClass('d-none');
                }
                
                resetCards();
                updateUI();
            });

            // 控制按鈕
            $('#drawBtn').on('click', drawCards);
            $('#resetBtn').on('click', resetCards);
            $('#shuffleBtn').on('click', shuffleCards);

            // 卡片點擊
            $(document).on('click', '.tarot-card', function() {
                selectCard($(this).data('card-id'));
            });
        }

        // 渲染卡片
        function renderCards() {
            const cardDeck = $('#cardDeck');
            cardDeck.empty();
            
            lenormandCards.forEach(card => {
                const cardHtml = `
                    <div class="tarot-card" data-card-id="${card.id}">
                        <div class="card-face card-back">
                            <i class="bi bi-stars"></i>
                        </div>
                        <div class="card-face card-front">
                            <div class="card-number">${card.id}</div>
                            <div class="card-symbol">${card.symbol}
                            <div class="card-symbol">${card.symbol}</div>
                            <div class="card-name">${card.name}</div>
                            <div class="card-meaning">${card.meaning}</div>
                        </div>
                    </div>
                `;
                cardDeck.append(cardHtml);
            });
        }

        // 更新UI
        function updateUI() {
            const cardCounts = {
                'single': 1,
                'three': 3,
                'five': 5,
                'nine': 9
            };
            
            const totalNeeded = cardCounts[currentMode];
            const selectedCount = selectedCards.length;
            
            $('#selectedCount').text(selectedCount);
            $('#totalNeeded').text(totalNeeded);
            
            const progress = (selectedCount / totalNeeded) * 100;
            $('#progressBar').css('width', progress + '%');
            
            // 更新按鈕狀態
            if (selectedCount === totalNeeded) {
                $('#drawBtn').prop('disabled', true).html('<i class="bi bi-check-circle"></i><br><small>完成</small>');
                setTimeout(() => {
                    showReading();
                }, 500);
            } else {
                $('#drawBtn').prop('disabled', false).html('<i class="bi bi-magic"></i><br><small>抽卡</small>');
            }
        }

        // 洗牌動畫
        function shuffleCards() {
            $('.tarot-card').each(function(index) {
                const $card = $(this);
                setTimeout(() => {
                    $card.css({
                        'transform': `translateY(${Math.random() * 20 - 10}px) rotateZ(${Math.random() * 10 - 5}deg)`,
                        'transition': 'transform 0.3s ease'
                    });
                    setTimeout(() => {
                        $card.css('transform', '');
                    }, 300);
                }, index * 20);
            });
            
            // 觸覺反饋
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // 自動抽卡
        function drawCards() {
            if (isDrawing) return;
            
            isDrawing = true;
            resetCards();
            
            const cardCounts = {
                'single': 1,
                'three': 3,
                'five': 5,
                'nine': 9
            };
            
            const cardCount = cardCounts[currentMode];
            const availableCards = [...lenormandCards];
            const drawnCards = [];

            // 隨機選擇卡片
            for (let i = 0; i < cardCount; i++) {
                const randomIndex = Math.floor(Math.random() * availableCards.length);
                drawnCards.push(availableCards.splice(randomIndex, 1)[0]);
            }

            // 翻牌動畫
            drawnCards.forEach((card, index) => {
                setTimeout(() => {
                    const $cardElement = $(`.tarot-card[data-card-id="${card.id}"]`);
                    $cardElement.addClass('flipped selected');
                    selectedCards.push(card);
                    
                    // 觸覺反饋
                    if (navigator.vibrate) {
                        navigator.vibrate(30);
                    }
                    
                    updateUI();
                    
                    if (index === drawnCards.length - 1) {
                        isDrawing = false;
                    }
                }, index * 300);
            });
        }

        // 手動選卡
        function selectCard(cardId) {
            if (isDrawing) return;

            const cardCounts = {
                'single': 1,
                'three': 3,
                'five': 5,
                'nine': 9
            };
            
            const cardCount = cardCounts[currentMode];

            if (selectedCards.length >= cardCount) return;

            const card = lenormandCards.find(c => c.id === cardId);
            const $cardElement = $(`.tarot-card[data-card-id="${cardId}"]`);
            
            if ($cardElement.hasClass('flipped')) return;

            $cardElement.addClass('flipped selected');
            selectedCards.push(card);
            
            // 觸覺反饋
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }

            updateUI();
        }

        // 顯示占卜結果
        function showReading() {
            displaySelectedCards();
            generateInterpretation();
            
            // 顯示模態框
            const readingModal = new bootstrap.Modal(document.getElementById('readingModal'));
            readingModal.show();
            
            // 觸覺反饋
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
        }

        // 顯示選中的卡片
        function displaySelectedCards() {
            const $selectedCardsDisplay = $('#selectedCardsDisplay');
            $selectedCardsDisplay.removeClass().addClass(`selected-cards ${currentMode}`);
            $selectedCardsDisplay.empty();

            selectedCards.forEach((card, index) => {
                let positionBadge = '';
                if (currentMode === 'nine') {
                    positionBadge = `<div class="position-badge">${index + 1}</div>`;
                }
                
                const cardHtml = `
                    <div class="selected-card fade-in">
                        ${positionBadge}
                        <div class="card-symbol">${card.symbol}</div>
                        <h6>${card.name}</h6>
                        <div class="card-meaning">${card.meaning}</div>
                    </div>
                `;
                $selectedCardsDisplay.append(cardHtml);
            });
        }

        // 生成解讀內容
        function generateInterpretation() {
            const $interpretationContent = $('#interpretationContent');
            $interpretationContent.empty();
            
            let interpretationHtml = '';

            if (currentMode === 'single') {
                interpretationHtml = `
                    <div class="position-reading">
                        <h6><i class="bi bi-star-fill"></i> 卡片指引</h6>
                        <p>${selectedCards[0].interpretation}</p>
                    </div>
                `;
            } else if (currentMode === 'three') {
                interpretationHtml = `
                    <div class="position-reading">
                        <h6><i class="bi bi-arrow-left-circle"></i> 過去</h6>
                        <p>${selectedCards[0].interpretation}</p>
                    </div>
                    <div class="position-reading">
                        <h6><i class="bi bi-circle-fill"></i> 現在</h6>
                        <p>${selectedCards[1].interpretation}</p>
                    </div>
                    <div class="position-reading">
                        <h6><i class="bi bi-arrow-right-circle"></i> 未來</h6>
                        <p>${selectedCards[2].interpretation}</p>
                    </div>
                    <div class="position-reading">
                        <h6><i class="bi bi-lightbulb"></i> 整體指引</h6>
                        <p>這三張卡片顯示了您生命中的時間流動，從過去的經驗到現在的狀況，再到未來的可能發展。過去的經歷為現在奠定了基礎，而現在的選擇將決定未來的方向。</p>
                    </div>
                `;
            } else if (currentMode === 'five') {
                interpretationHtml = `
                    <div class="position-reading">
                        <h6><i class="bi bi-bullseye"></i> 核心問題</h6>
                        <p>${selectedCards[2].interpretation}</p>
                    </div>
                    <div class="position-reading">
                        <h6><i class="bi bi-clock-history"></i> 過去影響</h6>
                        <p>${selectedCards[0].interpretation}</p>
                    </div>
                    <div class="position-reading">
                        <h6><i class="bi bi-lightning"></i> 現在狀況</h6>
                        <p>${selectedCards[1].interpretation}</p>
                    </div>
                    <div class="position-reading">
                        <h6><i class="bi bi-sunrise"></i> 未來發展</h6>
                        <p>${selectedCards[3].interpretation}</p>
                    </div>
                    <div class="position-reading">
                        <h6><i class="bi bi-trophy"></i> 最終結果</h6>
                        <p>${selectedCards[4].interpretation}</p>
                    </div>
                    <div class="position-reading">
                        <h6><i class="bi bi-lightbulb"></i> 整體指引</h6>
                        <p>這個五卡牌陣為您提供了全面的洞察，從問題的核心到最終的結果。理解過去的影響，把握現在的機會，為未來做好準備。</p>
                    </div>
                `;
            } else if (currentMode === 'nine') {
                interpretationHtml = generateNineGridInterpretation();
            }

            $interpretationContent.html(interpretationHtml);
        }

        // 生成九宮格解讀
        function generateNineGridInterpretation() {
            let interpretation = '';
            
            // 個別位置解讀
            selectedCards.forEach((card, index) => {
                const position = nineGridPositions[index];
                interpretation += `
                    <div class="position-reading">
                        <h6><i class="bi bi-${index + 1}-circle"></i> ${position.title}</h6>
                        <p><strong>${card.name} ${card.symbol}</strong> - ${position.description}</p>
                        <p>${card.interpretation}</p>
                    </div>
                `;
            });

            // 時間軸分析
            interpretation += `
                <div class="position-reading">
                    <h6><i class="bi bi-clock"></i> 時間軸分析</h6>
                    <p><strong>過去階段（位置1-3）：</strong>${generateTimeAnalysis([0, 1, 2])}</p>
                    <p><strong>現在階段（位置4-6）：</strong>${generateTimeAnalysis([3, 4, 5])}</p>
                    <p><strong>未來階段（位置7-9）：</strong>${generateTimeAnalysis([6, 7, 8])}</p>
                </div>
            `;

            // 核心洞察
            interpretation += `
                <div class="position-reading">
                    <h6><i class="bi bi-gem"></i> 核心洞察</h6>
                    <p>位置5的「${selectedCards[4].name}」是整個牌陣的核心，它揭示了問題的本質。結合其他八張卡片的能量，這個牌陣顯示了一個完整的生命週期和發展軌跡。</p>
                </div>
            `;

            // 行動建議
            interpretation += `
                <div class="position-reading">
                    <h6><i class="bi bi-compass"></i> 行動建議</h6>
                    <p>${generateActionAdvice()}</p>
                </div>
            `;

            return interpretation;
        }

        // 生成時間軸分析
        function generateTimeAnalysis(positions) {
            const cards = positions.map(pos => selectedCards[pos]);
            const cardNames = cards.map(card => card.name).join('、');
            
            // 能量分析
            const positiveCards = ['三葉草', '星星', '太陽', '心', '花束', '狗', '鑰匙', '錨'];
            const challengingCards = ['雲', '蛇', '棺材', '鐮刀', '鞭子', '山', '老鼠', '十字架'];
            
            let positiveCount = 0;
            let challengingCount = 0;
            
            cards.forEach(card => {
                if (positiveCards.includes(card.name)) positiveCount++;
                if (challengingCards.includes(card.name)) challengingCount++;
            });
            
            if (positiveCount > challengingCount) {
                return `這個階段整體能量偏向正面，${cardNames}的組合顯示了成長和機會。`;
            } else if (challengingCount > positiveCount) {
                return `這個階段面臨一些挑戰，${cardNames}提醒您需要謹慎應對。`;
            } else {
                return `這個階段呈現平衡狀態，${cardNames}顯示了機會與挑戰並存。`;
            }
        }

        // 生成行動建議
        function generateActionAdvice() {
            const coreCard = selectedCards[4]; // 位置5的核心卡片
            const futureCard = selectedCards[8]; // 位置9的結果卡片
            
            const adviceMap = {
                '騎士': '保持敏捷和行動力，抓住快速變化的機會。',
                '三葉草': '相信自己的幸運，保持樂觀的態度。',
                '船': '準備好迎接新的旅程或變化。',
                '房屋': '專注於建立穩固的基礎和安全感。',
                '樹': '關注健康和個人成長，培養耐心。',
                '雲': '保持清醒的判斷力，不要被表象迷惑。',
                '蛇': '提高警覺，謹慎處理複雜的人際關係。',
                '棺材': '準備好放下過去，迎接新的開始。',
                '花束': '增進社交關係，接受他人的善意。',
                '鐮刀': '做好應對突發狀況的準備。',
                '鞭子': '學會處理衝突，保持內心的平靜。',
                '鳥': '加強溝通技巧，傾聽內心的聲音。',
                '孩子': '保持好奇心和創新精神。',
                '狐狸': '運用智慧和策略，保持謹慎。',
                '熊': '發揮自己的力量，保護重要的人事物。',
                '星星': '堅持夢想，相信願望會實現。',
                '鸛': '擁抱變化，適應新的環境。',
                '狗': '珍惜忠誠的友誼，保持誠信。',
                '塔': '學會獨立思考，不要過度依賴他人。',
                '花園': '積極參與社交活動，擴展人脈。',
                '山': '培養耐心和毅力，逐步克服障礙。',
                '道路': '仔細考慮各種選擇，做出明智的決定。',
                '老鼠': '保護自己的資源，避免不必要的損失。',
                '心': '跟隨內心的聲音，珍惜感情。',
                '戒指': '重視承諾和約定，建立長期關係。',
                '書': '持續學習，探索隱藏的知識。',
                '信': '注意重要的信息和溝通。',
                '男人': '發揮領導力和行動力。',
                '女人': '信任直覺，運用感性智慧。',
                '百合': '保持內心的平靜和純潔。',
                '太陽': '保持積極樂觀，發揮正面能量。',
                '月亮': '相信直覺，關注內在的週期。',
                '鑰匙': '尋找問題的關鍵解決方案。',
                '魚': '關注財務狀況，尋求經濟獨立。',
                '錨': '建立穩定的基礎，保持可靠性。',
                '十字架': '接受必要的犧牲，從困難中學習。'
            };
            
            const coreAdvice = adviceMap[coreCard.name] || '保持開放的心態，相信自己的判斷。';
            const futureAdvice = adviceMap[futureCard.name] || '為未來做好準備，保持希望。';
            
            return `基於核心卡片「${coreCard.name}」的指引：${coreAdvice} 而最終結果「${futureCard.name}」提醒您：${futureAdvice}`;
        }

        // 重置卡片
        function resetCards() {
            selectedCards = [];
            $('.tarot-card').removeClass('flipped selected');
            updateUI();
            
            // 觸覺反饋
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // 防止頁面縮放
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        // 防止雙擊縮放
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
